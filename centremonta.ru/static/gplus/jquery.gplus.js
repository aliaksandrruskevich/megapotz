(function(e,t,n){"use strict";function s(t,r,s){this.element=t;this.photos=r;this.options=e.extend({},i,s);this.rows=[];this.treeBuilt=false;this.oRootDiv=n.createElement("div");this.oImgs=[];this.init()}function o(e,t,n,r){this.options=n;this.photos=t;this.screenHeight=0;this.screenWidth=0;this.screenRatio=1;this.selfDestroy=r;this.current=e>=t.length?0:e;this.state=this.current===t.length-1?"replay":"play";this.HTMLTemplate={layout:'<div id="gplus-fullscreen-layout"><div class="gplus-picture-holder"><div class="gplus-picture-aligner"><img id="gplus-picture" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" alt=""/></div></div><div id="gplus-ui"><div id="gplus-go-left"><div class="gplus-arrow"></div></div><div id="gplus-go-right"><div class="gplus-arrow"></div></div><div class="gplus-pult"><div id="gplus-button-left"><div class="gplus-button-highlighter"></div></div><div id="gplus-button-right"><div class="gplus-button-highlighter"></div></div><div id="gplus-caption-left"><div class="gplus-caption-icon"></div><span class="gplus-caption-play">Приостановить</span><span class="gplus-caption-stop">Продолжить</span><span class="gplus-caption-replay">Начать заново</span></div><div id="gplus-caption-right"><div class="gplus-caption-icon"></div></div></div></div><div id="gplus-spinner"></div></div>',fullscreenHint:'<div id="gplus-fullscreen-tip" class="hidden"><p>Нажмите <span style="color: #f00">Enter</span>, чтобы смотреть фото во весь размер экрана.</p></div>'};this.init()}var r="GPlusGallery";var i={pictureMarginRight:6,minRowAspectRatio:4,tickDuration:300,hideUIDelay:6,slideInterval:10,fullscreenHintDelay:5e3,spinner:undefined};s.prototype={init:function(){this.oRootDiv.setAttribute("id","gplus-gallery-grid");this.element.appendChild(this.oRootDiv);var n=this;e(this.oRootDiv).on("click","div",function(){n.oFullscreen=new o(e(this).index(),n.photos,n.options,function(){delete n.oFullscreen;n.show()})});for(var r=0,i=this.photos.length;r<i;r++){this.photos[r].aspectRatio=this.photos[r].width/this.photos[r].height;this.photos[r].url=this.photos[r].url.substring(0,83)}var s=this.options.minRowAspectRatio;for(var r=0,u=0,a=0,i=this.photos.length;r<i;r++){a+=this.photos[r].aspectRatio;if(a>s){this.rows.push({rowAspectRatio:a,startIndex:u,endIndex:r});u=r+1;a=0}}if(a!==0){this.rows.push({rowAspectRatio:s,startIndex:u,endIndex:r-1})}this.show();var f=false;e(t).on("resize",function(){if(f!==false){t.clearTimeout(f)}f=t.setTimeout(function(){n.show()},500)})},show:function(){if(this.oFullscreen){return false}var t=e(this.oRootDiv).width();if(!this.treeBuilt){var r=n.createDocumentFragment()}for(var i=0,s=this.rows.length;i<s;i++){var o=this.rows[i];var u=this.options.pictureMarginRight*(o.endIndex-o.startIndex);var a=(t-u)/o.rowAspectRatio;var f=Math.floor(a);var l=0;for(var c=o.startIndex,h=o.endIndex;c<=h;c++){var p=Math.floor(this.photos[c].aspectRatio*a);l+=p;this.photos[c].calculatedWidth=p;this.photos[c].calculatedHeight=f}var d=t-(l+u);for(var c=o.startIndex,h=o.endIndex;c<=h&&d;c++){this.photos[c].calculatedWidth++;d--}if(!this.treeBuilt){for(var c=o.startIndex,h=o.endIndex;c<=h;c++){var v=n.createElement("div");v.setAttribute("class","pic");if(c===h){v.setAttribute("style","margin-right: 0")}var m=n.createElement("img");m.setAttribute("style","width: "+this.photos[c].calculatedWidth+"px; height: "+this.photos[c].calculatedHeight+"px");m.setAttribute("src",this.photos[c].url+"w"+this.photos[c].calculatedWidth+"-h"+this.photos[c].calculatedHeight+"-n/");m.setAttribute("alt",this.photos[c].title);this.oImgs.push(m);v.appendChild(m);r.appendChild(v)}}}if(this.treeBuilt){for(var i=0,s=this.photos.length;i<s;i++){var g=this.photos[i];this.oImgs[i].setAttribute("style","width: "+g.calculatedWidth+"px; height: "+g.calculatedHeight+"px");this.oImgs[i].setAttribute("src",g.url+"w"+g.calculatedWidth+"-h"+g.calculatedHeight+"-n/")}}if(!this.treeBuilt){this.oRootDiv.appendChild(r);this.treeBuilt=true}}};o.prototype={init:function(){var r=this;e("body").append(this.HTMLTemplate.layout);this.rootNode=e("#gplus-fullscreen-layout");if(this.options&&this.options.spinner){this.spinner=this.options.spinner}else{this.spinner={el:n.getElementById("gplus-spinner"),spin:function(){this.el.className="css-spinner"},stop:function(){this.el.className="css-spinner hidden"}}}this.getScreenDimensions();this.updatePicture();if(n.cancelFullScreen||n.mozCancelFullScreen||n.webkitCancelFullScreen){this.fullscreenHint=e(this.HTMLTemplate.fullscreenHint).appendTo("#gplus-fullscreen-layout").removeClass("hidden");t.setTimeout(function(){r.fullscreenHint.addClass("hidden").on("webkitTransitionEnd transitionend msTransitionEnd oTransitionEnd otransitionend",function(){this.style.display="none"})},this.options.fullscreenHintDelay)}var i=0;var s=0,o=0,u=0;var a=0;this.ticker=t.setInterval(function(){if(i===r.options.slideInterval){r.autoplay();i=0}if(s===r.options.hideUIDelay){e("#gplus-fullscreen-layout").addClass("no-ui")}if(a===2){r.getScreenDimensions();r.updatePicture()}i++;a++;s++},this.options.tickDuration);e(n).on("mousemove.GPlusFullscreen",function(t){if(Math.abs(o-t.pageX)>5||Math.abs(u-t.pageY)>5){s=0;e("#gplus-fullscreen-layout").removeClass("no-ui")}o=t.pageX;u=t.pageY});e(t).on("resize.GPlusFullscreen",function(){a=0});e(n).on("keydown.GPlusFullscreen",function(t){switch(t.keyCode){case 13:r.toggleFullscreen();break;case 37:r.prev();break;case 39:r.next();break;case 32:e("#gplus-caption-left").click();break}});e("#gplus-picture").on("load",function(){r.spinner.stop();i=0});e("#gplus-go-left, #gplus-go-right").on("mouseenter mouseleave",function(){e(this).toggleClass("hover")});e("#gplus-caption-left").on("mouseenter mouseleave",function(){e("#gplus-button-left").toggleClass("hover")});e("#gplus-caption-right").on("mouseenter mouseleave",function(){e("#gplus-button-right").toggleClass("hover")});e("#gplus-go-left").on("click",function(){r.prev()});e("#gplus-go-right").on("click",function(){r.next()});e("#gplus-caption-left").on("click",function(){switch(r.state){case"stop":r.state="play";i=0;break;case"replay":r.current=0;i=0;r.state="play";break;case"play":r.state="stop";break}r.updatePicture()});e("#gplus-caption-right").click(function(){r.deinit()})},deinit:function(){t.clearInterval(this.ticker);e(n).off(".GPlusFullscreen");e(t).off("resize.GPlusFullscreen");e("#gplus-picture").off();e("#gplus-go-left, #gplus-go-right, #gplus-caption-left, #gplus-caption-right").off();if(this.fullscreenHint){this.fullscreenHint.off()}e("#gplus-fullscreen-layout").remove();this.selfDestroy()},updatePicture:function(){e("#gplus-go-left").removeClass().addClass(this.current===0?"hidden":"");e("#gplus-go-right").removeClass().addClass(this.current===this.photos.length-1?"hidden":"");var t=e("#gplus-picture")[0];if(e("body").attr("id")==="page-index"){if(this.current===this.photos.length-1&&e(t).parent().prop("tagName")!=="A"){e(t).wrap('<a href="/portfolio/process/"/>')}else if(this.current!==this.photos.length-1&&e(t).parent().prop("tagName")==="A"){e(t).unwrap()}}var n=this.photos[this.current].url;if(this.photos[this.current].aspectRatio>this.screenRatio){n+="w"+this.screenWidth+"/"}else{n+="h"+this.screenHeight+"/"}if(t.src!==n){t.src=n;this.spinner.spin(e("#gplus-spinner")[0])}e("#gplus-caption-left")[0].className=this.state},prev:function(){if(this.current>0){this.current--;this.updatePicture()}},next:function(){if(this.current<this.photos.length-1){this.current++;if(this.current===this.photos.length-1){this.state="replay";e("#gplus-fullscreen-layout").removeClass("no-ui")}}this.updatePicture()},autoplay:function(){if(this.state==="play"){this.next()}},getScreenDimensions:function(){this.screenWidth=this.rootNode.width();this.screenHeight=this.rootNode.height();this.screenRatio=this.screenWidth/this.screenHeight},toggleFullscreen:function(){if(n.fullScreenElement&&n.fullScreenElement!==null||!n.mozFullScreen&&!n.webkitIsFullScreen){if(this.rootNode[0].requestFullScreen){this.rootNode[0].requestFullScreen()}else if(this.rootNode[0].mozRequestFullScreen){this.rootNode[0].mozRequestFullScreen()}else if(this.rootNode[0].webkitRequestFullScreen){this.rootNode[0].webkitRequestFullScreen()}e("#gplus-fullscreen-tip").hide()}else{if(n.cancelFullScreen){n.cancelFullScreen()}else if(n.mozCancelFullScreen){n.mozCancelFullScreen()}else if(n.webkitCancelFullScreen){n.webkitCancelFullScreen()}}}};e.fn[r]=function(t,n){return this.each(function(){if(!e.data(this,"plugin_"+r)){e.data(this,"plugin_"+r,new s(this,t,n))}})}})(jQuery,window,document)